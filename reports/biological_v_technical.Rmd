---
title: "Biological versus Technical Variability"
author: "Jackie Meisel"
date: '`r Sys.Date()`'
output:
  bookdown::pdf_document2: 
    toc: FALSE
---

<!--
Biological versus technical variation results section, comparison of pairwise distances between biological and technical replicates and partitioning total variation into biological and technical components. 
-->

```{r bioVtechSetup, warning=FALSE, message=FALSE, echo = FALSE}
library(ProjectTemplate)
load.project()
## load required libraries
```

```{r bioVtechMunge, warning=FALSE, message=FALSE, echo = FALSE}
## Pre-processing data for figure(s)
biol_v_tech_variation_summary_highlevel <- biol_v_tech_variation[[3]] %>% 
    group_by(variation, pipe, normalization, metric, normalization_type) %>%
    summarise(mean_value = mean(value), 
              stdev = sd(value), 
              N = n(), 
              se = stdev/sqrt(N))

biol_v_tech_variation_summary_higherlevel <- biol_v_tech_variation_summary_highlevel[, 1:6] %>%
    spread(variation, mean_value) %>%
    mutate(mean_difference  = biological - technical) %>% 
    mutate(f_type = if_else(metric %in% c("unifrac","wunifrac"), 
                        "Phylogenetic","Taxonomic"),
            weight = if_else(metric %in% c("unifrac","jaccard"),
                        "Unweighted", "Weighted"))
```

```{r bioVtechPlot1, warning=FALSE, message=FALSE, echo = FALSE, fig.cap = "Biological vs. Technical Variation, y-axis is the differences between the mean biological and technical variation (pairwise distance between replicates.)"}
biol_v_tech_variation_summary_higherlevel %>% 
    ggplot(aes(x = normalization, y = mean_difference, 
               color = pipe, group = pipe)) + 
        geom_point(size = 2) + 
        geom_line() + 
        theme_bw() + 
        facet_grid(f_type~weight, scales = "free_x") + 
        theme(axis.text.x = element_text(angle = -45, hjust = 0)) + 
        scale_colour_brewer(palette = "Dark2") + 
        labs(x = "Rarefaction Level", y = "Biological - Technical")
```

```{r bioVtechPlot2, warning=FALSE, message=FALSE, echo = FALSE, fig.cap = "Biological vs. Technical Variation, y-axis is the adjusted R^2 value, indicating proportion of variance explained by each biological (subject and titration) and technical (seq run) variable"}
varpart_stats %>% subset(effect=="conditional") %>%
    ggplot(aes(x=factor(normalization, 
                        levels=c("RAW", "rare2000", "rare5000", "rare10000", "rareq15", "CSS", 
                                 "RLE", "TMM", "TSS", "UQ"), ordered = T), 
               y=Adj.R.square, fill=feature))+
              geom_bar(stat="identity")+
              theme_bw()+theme(axis.text.x=element_text(angle = -45, hjust = 0))+
              xlab("")+ylab("Adjusted R^2")+
              scale_fill_manual(values = c("gray","#d53e4f", "#3288bd"))+
    facet_grid(pipe~metric, scales="free_x", space="free")


# varpart_stats %>% subset(effect=="conditional") %>%
#     ggplot(aes(x=factor(normalization, 
#                         levels=c("RAW", "rare2000", "rare5000", "rare10000", "rareq15", "CSS", 
#                                  "RLE", "TMM", "TSS", "UQ"), ordered = T), 
#                y=Adj.R.square, color=feature, shape=feature))+
#               geom_point(position=position_jitter(width=0.2))+
#               theme_bw()+theme(axis.text.x=element_text(angle = -45, hjust = 0))+
#               xlab("")+ylab("Adjusted R^2")+
#               scale_color_manual(values = c("gray","#d53e4f", "#3288bd"))+
#     facet_grid(pipe~metric, scales="free_x", space="free")
```

__Key Points__  

Beta-diversity distances between biological and technical replicates varies by pipeline and beta-diversity metric (Fig. \@ref(fig:bioVtechPlot1)).  

* Generally, greater differences between biological and technical replicates were observed using taxonomic metrics, rather than pylogenetic metrics (with the exception of mothur for weighted phylogenetic metrics).

* For weighted metrics, RLE and TMM decreased the difference relative to raw counts indicating that for beta diversity analysis these normalization methods reduce the power to distingush true biological differences from technical variability or noise.  

*In general, rarified count data had higher mean difference between biological and technical variation (excluding when rarefying to 15th quantile for qiime de novo, closed , and open-reference, which is potentially due to sample loss). 

Generally, biological features (subject and titration factor) explain most of the observed variance (Fig. \@ref(fig:bioVtechPlot1)).  

* Un-normalized (raw) datasets often showed greater influence of technical factors (seq run)

* Non-rarefaction normalization metrics (esp. RLE and TMM) showed greater influence of technical factors (seq run)-- especially for QIIME pipelines